openapi: 3.0.3
info:
  title: WASAText API
  description: WASAText messaging service API for Web and Software Architecture course
  version: "1.0.0"
servers:
  - url: http://localhost:3000

paths:
  /session:
    post:
      tags: ["Login"]
      operationId: doLogin
      summary: Logs in the user
      description: |
        If the user does not exist, it will be created, and an identifier is returned.
        If the user exists, the user identifier is returned.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 3
                  maxLength: 16
                  pattern: "^[a-zA-Z0-9_]+$"
                  example: "Maria"
                  description: Username for login
      responses:
        "201":
          description: User logged in successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /users/{userId}/username:
    parameters:
      - $ref: "#/components/parameters/userId"
    put:
      tags: ["User"]
      operationId: setMyUserName
      summary: Change username
      description: Sets a new username for the user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 16
                  pattern: "^[a-zA-Z0-9_]+$"
      responses:
        "204":
          description: Username changed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Username already taken
        "500":
          $ref: "#/components/responses/InternalServerError"

  /users/{userId}/photo:
    parameters:
      - $ref: "#/components/parameters/userId"
    put:
      tags: ["User"]
      operationId: setMyPhoto
      summary: Set user profile photo
      description: Uploads a new profile photo for the user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          image/png:
            schema:
              type: string
              format: binary
          image/jpeg:
            schema:
              type: string
              format: binary
      responses:
        "204":
          description: Photo updated successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /users/{userId}/conversations:
    parameters:
      - $ref: "#/components/parameters/userId"
    get:
      tags: ["Conversations"]
      operationId: getMyConversations
      summary: Get user conversations
      description: Returns all conversations (private and group) for the user, sorted in reverse chronological order
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ConversationPreview"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /conversations/{conversationId}:
    parameters:
      - $ref: "#/components/parameters/conversationId"
    get:
      tags: ["Conversations"]
      operationId: getConversation
      summary: Get conversation messages
      description: Returns all messages in a conversation, sorted in reverse chronological order. Marks messages as read for the user.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Conversation with messages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a member of this conversation
        "404":
          description: Conversation not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /conversations/{conversationId}/messages:
    parameters:
      - $ref: "#/components/parameters/conversationId"
    post:
      tags: ["Messages"]
      operationId: sendMessage
      summary: Send a message
      description: Sends a text or photo message to the conversation. Can optionally be a reply.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum: ["text", "photo"]
                content:
                  type: string
                  description: Text content (required if type is text)
                replyToId:
                  type: string
                  description: Message ID being replied to (optional)
          multipart/form-data:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: ["photo"]
                photo:
                  type: string
                  format: binary
                replyToId:
                  type: string
      responses:
        "201":
          description: Message sent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a member of this conversation
        "500":
          $ref: "#/components/responses/InternalServerError"

  /conversations/{conversationId}/messages/forward:
    parameters:
      - $ref: "#/components/parameters/conversationId"
    post:
      tags: ["Messages"]
      operationId: forwardMessage
      summary: Forward a message
      description: Forwards an existing message to this conversation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - messageId
              properties:
                messageId:
                  type: string
                  description: ID of the message to forward
      responses:
        "201":
          description: Message forwarded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a member of this conversation
        "404":
          description: Original message not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /messages/{messageId}:
    parameters:
      - $ref: "#/components/parameters/messageId"
    delete:
      tags: ["Messages"]
      operationId: deleteMessage
      summary: Delete a message
      description: Deletes a message. Only the sender can delete their own messages.
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Message deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not the sender of this message
        "404":
          description: Message not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /messages/{messageId}/comment:
    parameters:
      - $ref: "#/components/parameters/messageId"
    put:
      tags: ["Reactions"]
      operationId: commentMessage
      summary: Add a comment/reaction to a message
      description: Adds or updates the user's comment on a message. Each user can have only one comment per message.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - comment
              properties:
                comment:
                  type: string
                  maxLength: 50
                  description: The comment or reaction emoji
      responses:
        "204":
          description: Comment added successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Message not found
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      tags: ["Reactions"]
      operationId: uncommentMessage
      summary: Remove a comment/reaction from a message
      description: Removes the user's comment from a message
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Comment removed successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Message or comment not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /groups:
    post:
      tags: ["Groups"]
      operationId: createGroup
      summary: Create a new group
      description: Creates a new group conversation with the creator as the first member
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  description: Group name
      responses:
        "201":
          description: Group created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Group"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /groups/{groupId}/members:
    parameters:
      - $ref: "#/components/parameters/groupId"
    post:
      tags: ["Groups"]
      operationId: addToGroup
      summary: Add a user to the group
      description: Adds a user to the group. Only group members can add others.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: User identifier to add
      responses:
        "204":
          description: User added successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Requester is not a member of this group
        "404":
          description: Group or user not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /groups/{groupId}/members/{userId}:
    parameters:
      - $ref: "#/components/parameters/groupId"
      - $ref: "#/components/parameters/userId"
    delete:
      tags: ["Groups"]
      operationId: leaveGroup
      summary: Leave the group
      description: Removes the user from the group. Users can only remove themselves.
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Left group successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User can only remove themselves
        "404":
          description: Group not found or user not a member
        "500":
          $ref: "#/components/responses/InternalServerError"

  /groups/{groupId}/name:
    parameters:
      - $ref: "#/components/parameters/groupId"
    put:
      tags: ["Groups"]
      operationId: setGroupName
      summary: Set group name
      description: Changes the group name. Only members can change it.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 50
      responses:
        "204":
          description: Group name changed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a member of this group
        "404":
          description: Group not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /groups/{groupId}/photo:
    parameters:
      - $ref: "#/components/parameters/groupId"
    put:
      tags: ["Groups"]
      operationId: setGroupPhoto
      summary: Set group photo
      description: Sets the group photo. Only members can change it.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          image/png:
            schema:
              type: string
              format: binary
          image/jpeg:
            schema:
              type: string
              format: binary
      responses:
        "204":
          description: Group photo changed successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: User is not a member of this group
        "404":
          description: Group not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /users:
    get:
      tags: ["User"]
      operationId: searchUsers
      summary: Search users
      description: Search for users by username to start conversations
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          description: Search query (username substring)
          required: true
          schema:
            type: string
            minLength: 1
      responses:
        "200":
          description: List of matching users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /conversations:
    post:
      tags: ["Conversations"]
      operationId: startConversation
      summary: Start a private conversation
      description: Creates or returns an existing private conversation with another user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: The user to start a conversation with
      responses:
        "200":
          description: Existing conversation returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationPreview"
        "201":
          description: New conversation created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConversationPreview"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: User not found
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: User identifier returned from doLogin

  parameters:
    userId:
      name: userId
      in: path
      required: true
      description: User identifier
      schema:
        type: string
    conversationId:
      name: conversationId
      in: path
      required: true
      description: Conversation identifier
      schema:
        type: string
    messageId:
      name: messageId
      in: path
      required: true
      description: Message identifier
      schema:
        type: string
    groupId:
      name: groupId
      in: path
      required: true
      description: Group identifier
      schema:
        type: string

  schemas:
    LoginResponse:
      type: object
      properties:
        identifier:
          type: string
          description: User identifier to use as Bearer token
          example: "abcdef012345"
      required:
        - identifier

    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        photoUrl:
          type: string
          nullable: true
      required:
        - id
        - username

    ConversationPreview:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: ["private", "group"]
        name:
          type: string
          description: Username for private, group name for group
        photoUrl:
          type: string
          nullable: true
        latestMessage:
          $ref: "#/components/schemas/MessagePreview"
      required:
        - id
        - type
        - name

    MessagePreview:
      type: object
      properties:
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        senderId:
          type: string
      required:
        - content
        - timestamp
        - senderId

    Conversation:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: ["private", "group"]
        name:
          type: string
        photoUrl:
          type: string
          nullable: true
        members:
          type: array
          items:
            $ref: "#/components/schemas/User"
        messages:
          type: array
          items:
            $ref: "#/components/schemas/Message"
      required:
        - id
        - type
        - name
        - members
        - messages

    Message:
      type: object
      properties:
        id:
          type: string
        senderId:
          type: string
        senderUsername:
          type: string
        type:
          type: string
          enum: ["text", "photo"]
        content:
          type: string
          description: Text content or photo URL
        timestamp:
          type: string
          format: date-time
        checkmarks:
          type: integer
          enum: [0, 1, 2]
          description: "0=sent, 1=received by all, 2=read by all"
        replyTo:
          $ref: "#/components/schemas/MessagePreview"
          nullable: true
        forwarded:
          type: boolean
        comments:
          type: array
          items:
            $ref: "#/components/schemas/Comment"
      required:
        - id
        - senderId
        - senderUsername
        - type
        - content
        - timestamp
        - checkmarks
        - forwarded
        - comments

    Comment:
      type: object
      properties:
        userId:
          type: string
        username:
          type: string
        comment:
          type: string
      required:
        - userId
        - username
        - comment

    Group:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        photoUrl:
          type: string
          nullable: true
        members:
          type: array
          items:
            $ref: "#/components/schemas/User"
      required:
        - id
        - name
        - members

  responses:
    BadRequest:
      description: The request was not compliant with the documentation
    Unauthorized:
      description: The access token is missing or invalid
    InternalServerError:
      description: The server encountered an internal error
